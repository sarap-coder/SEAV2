#!/bin/sh

abspath="/opt/pal/gallium/bin"
cmd=`basename $0`

if [ -z "${OROCOS_TARGET}" ]; then
    possibilities=`echo $abspath/$cmd-*`
    if [ -z "$possibilities" -o ! -f "$possibilities" ]; then
        echo "You have not set the OROCOS_TARGET environment variable. I need it to know which target to run."
        echo "You can set it by doing for example: 'export OROCOS_TARGET=gnulinux' in your .bashrc"
        echo " or before you run this script."
        exit 1
    fi
    cmd=$possibilities
else
    cmd=$abspath/$cmd-${OROCOS_TARGET}
fi

# Search for an orocos path settings file.  This file is a list of relative
# paths to be added to the RTT_COMPONENT_PATH environment variable.  This makes
# it possible to ship code that builds and runs without forcing the user to
# manually set up environment environment variables.
# (Or rely on another software like ROS to do the forcing)
MAGIC_FILE_NAME=.rtt_component_path
scan_dir()
{
    if [ `find "$x" -maxdepth 1 -name $MAGIC_FILE_NAME` ]; then
        for p in `cat "$x"/$MAGIC_FILE_NAME`
        do
            export RTT_COMPONENT_PATH=${RTT_COMPONENT_PATH}:$x/$p
        done
        break
    fi
}

# In the past the rtt-based libraries and executables had a hard coded RPATH
# to be able to find libraries in non-standard directories
# This caused problems when overlaying workspaces, since the overlays would be occluded
# if a path in the RPATH had a library that should be loaded from the overlays
fix_ld_library_path()
{
    NEW_LD_LIBRARY_PATH=""
    split_string=$(echo $LD_LIBRARY_PATH| tr ":" "\n")
    for p in $split_string
    do
        components_path="$p/orocos/gnulinux"

        #Search for directories in lib/orocos/gnulinux/ 
        subdirs=`ls $components_path 2> /dev/null`
        for s in $subdirs
        do
            NEW_LD_LIBRARY_PATH="$NEW_LD_LIBRARY_PATH:$components_path/$s"
            NEW_LD_LIBRARY_PATH="$NEW_LD_LIBRARY_PATH:$components_path/$s/plugins"
            NEW_LD_LIBRARY_PATH="$NEW_LD_LIBRARY_PATH:$components_path/$s/types"
        done
        #This line adds path by path the original LD_LIBRARY_PATH paths in order
        NEW_LD_LIBRARY_PATH="$NEW_LD_LIBRARY_PATH:$p"
    done
    export LD_LIBRARY_PATH=$NEW_LD_LIBRARY_PATH
}

x=$PWD
scan_dir
until [ "$x" = "/" ]
do 
    x=`dirname "$x"`
    scan_dir
done
fix_ld_library_path

exec ${OROCOS_LAUNCH_PREFIX} "$cmd" "$@"
